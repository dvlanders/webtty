
<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@3.8.0/dist/xterm.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@3.8.0/dist/addons/fullscreen/fullscreen.css">
  <script src="https://cdn.jsdelivr.net/npm/xterm@3.8.0/dist/xterm.js"></script>
  <script src="attach.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm@3.8.0/dist/addons/fullscreen/fullscreen.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm@3.8.0/dist/addons/fit/fit.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.6/pako.min.js"></script>
  <style>
    #terminal {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      width: auto;
      height: auto;
      z-index: 255;
    }
  </style>
</head>

<body>
  <div id="terminal" />
  <script>
    Terminal.applyAddon(attach);
    Terminal.applyAddon(fullscreen);
    Terminal.applyAddon(fit);


    var term = new Terminal();
    term.open(document.getElementById("terminal"));
    term.toggleFullScreen();
    term.fit();
    window.onresize = () => {
      term.fit();
    }
    term.write("Welcome to the WebRTTY web client.\n\r");
    term.write("Run webrtty and paste the offer message below:\n\r");
    let firstInput = false;
    term.on("data", data => {
      if (!firstInput){
        term.reset()
        try {
            startSession(data)
        }
        catch(err) {
            term.write(`There was an error with the offer: ${data}\n\r`)
            term.write("Try entering the message again: ")
            return
        }
        firstInput = true;
      }
    });

    let pc = new RTCPeerConnection({
      iceServers: [
        {
          urls: "stun:stun.l.google.com:19302"
        }
      ]
    });

    let log = msg => {
      term.write(msg + "\n\r")
    };

    let sendChannel = pc.createDataChannel("data");
    sendChannel.onclose = () => console.log("sendChannel has closed");
    sendChannel.onopen = () => {
      term.reset()
      term.terminadoAttach(sendChannel);
      term.__getMessage = (ev) => {
        term.write(ev)
      }
      console.log("sendChannel has opened");
    };
    // sendChannel.onmessage = e => {}

    pc.onsignalingstatechange = e => log(pc.signalingState)
    pc.oniceconnectionstatechange = e => log(pc.iceConnectionState)
    pc.onicecandidate = event => {
      if (event.candidate === null) {
        term.write("Answer created. Send the following answer to the host:\n\r\n\r")
        term.write(btoa(pako.deflate(pc.localDescription.sdp, { to: "string" })))
          
      }
    }

    pc.onnegotiationneeded = e => console.log(e)

    window.sendMessage = () => {
      let message = document.getElementById("message").value;
      if (message === "") {
        return alert("Message must not be empty");
      }

      sendChannel.send(message);
    };

    startSession = (data) => {
      pc.setRemoteDescription(
        new RTCSessionDescription({
          type: "offer",
          sdp: pako.inflate(atob(data), { to: "string" })
        })
      ).catch(log)
      pc.createAnswer().then(d => pc.setLocalDescription(d)).catch(log)
    };
  </script>
  Browser base64 Session Description <textarea id="localSessionDescription" readonly="true"></textarea> <br />

  <br />

  Message: <textarea id="message">This is my DataChannel message!</textarea> <br/>
  <button onclick="window.sendMessage()"> Send Message </button> <br />

  <div id="logs"></div>
</body>
</html>
